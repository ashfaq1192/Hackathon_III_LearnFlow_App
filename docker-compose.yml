version: "3.8"

# LearnFlow - Local Development Environment
# Usage: docker compose up
# Requires .env file with OPENAI_API_KEY and DATABASE_URL

services:
  # Triage Service - AI agent for routing learner questions
  triage-service:
    build: ./src/services/triage-service
    ports:
      - "8001:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DAPR_HTTP_PORT=3500
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Concepts Service - AI agent for explaining Python concepts
  concepts-service:
    build: ./src/services/concepts-service
    ports:
      - "8002:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DAPR_HTTP_PORT=3500
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Exercise Service - CRUD API for coding exercises, grading, and quizzes
  exercise-service:
    build: ./src/services/exercise-service
    ports:
      - "8003:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DAPR_HTTP_PORT=3500
      - CODE_EXECUTION_SERVICE_URL=http://code-execution-service:8000
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Code Execution Service - Safe Python code executor
  code-execution-service:
    build: ./src/services/code-execution-service
    ports:
      - "8004:8000"
    environment:
      - DAPR_HTTP_PORT=3500
      - EXEC_TIMEOUT=10
      - MAX_OUTPUT_SIZE=10000
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Debug Service - AI agent for analyzing code errors
  debug-service:
    build: ./src/services/debug-service
    ports:
      - "8005:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DAPR_HTTP_PORT=3500
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Code Review Service - AI agent for reviewing code quality
  code-review-service:
    build: ./src/services/code-review-service
    ports:
      - "8006:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DAPR_HTTP_PORT=3500
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Progress Service - Student mastery tracking and curriculum data
  progress-service:
    build: ./src/services/progress-service
    ports:
      - "8007:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DAPR_HTTP_PORT=3500
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Frontend - Next.js + Monaco Editor
  frontend:
    build: ./src/frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - TRIAGE_SERVICE_URL=http://triage-service:8000
      - CONCEPTS_SERVICE_URL=http://concepts-service:8000
      - EXERCISE_SERVICE_URL=http://exercise-service:8000
      - CODE_EXECUTION_SERVICE_URL=http://code-execution-service:8000
      - DEBUG_SERVICE_URL=http://debug-service:8000
      - CODE_REVIEW_SERVICE_URL=http://code-review-service:8000
      - PROGRESS_SERVICE_URL=http://progress-service:8000
      - DATABASE_URL=${DATABASE_URL:-}
      - AUTH_SECRET=${AUTH_SECRET:-supersecretkey}
    depends_on:
      - triage-service
      - concepts-service
      - exercise-service
      - code-execution-service
      - debug-service
      - code-review-service
      - progress-service
